<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基于AI的安全头盔大数据分析与评估系统</title>
    <!-- 添加Three.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FFC107;
            --danger-color: #F44336;
            --success-color: #4CAF50;
            --text-color: #333;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-image: url('/templates/images/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
            line-height: 1.6;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto 20px 200px;
            background: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: none;
            border: 3px solid rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 10px;
        }

        .file-input-group {
            margin-bottom: 20px;
            background: transparent;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid rgba(255, 255, 255);
            transition: all 0.3s ease;
        }

        .file-input-group:hover {
            border-color: var(--primary-color);
            box-shadow: none;
        }

        .file-input-group button {
            background-color: transparent;
            border: 2px solid rgba(255, 255, 255);
            color: var(--primary-color);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            border-color: rgba(255, 255, 255);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-group button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: white;
            transform: translateY(-1px);
        }

        .file-input-group input[type="text"] {
            margin-left: 15px;
            padding: 10px;
            width: calc(100% - 220px);
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .button-group {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 180px;
            background: rgba(0, 0, 0, 0.75);
            padding: 20px 15px;
            border-right: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
            z-index: 1000;
        }

        .button-group button {
            background-color: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.7);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            width: 100%;
            margin: 0;
        }

        .button-group button:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .button-group button:active {
            transform: scale(0.98);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .button-group .primary-button {
            border-color: rgba(33, 150, 243, 0.7) !important;
            background-color: rgba(33, 150, 243, 0.2);
        }

        .button-group .primary-button:hover {
            background-color: rgba(33, 150, 243, 0.4);
            border-color: rgba(33, 150, 243, 0.9) !important;
        }

        .radio-group {
            background: transparent;
            padding: 10px 0;
            border-radius: var(--border-radius);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
        }

        .radio-group label {
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-group input[type="radio"] {
            cursor: pointer;
            appearance: none;
            background-color: transparent;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
        }

        .radio-group input[type="radio"]::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--primary-color);
        }

        .radio-group input[type="radio"]:checked::before {
            transform: scale(1);
        }

        .tab-group {
            margin-top: 30px;
        }

        .tab-button {
            background-color: transparent;
            color: white;
            border: 3px solid var(--danger-color);
            padding: 12px 25px;
            margin-right: 5px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-button:hover {
            background-color: rgba(211, 47, 47, 0.2);
        }

        .tab-button.active {
            background-color: rgba(211, 47, 47, 0.3);
        }

        .tab-content {
            background-color: transparent;
            padding: 25px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            min-height: 300px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: none;
        }

        #dangerContent {
            margin-top: 20px;
            padding: 15px;
            background-color: transparent;
            border-radius: var(--border-radius);
            font-size: 14px;
            line-height: 1.6;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            font-weight: 500;
        }

        .action-button:hover {
            background-color: #1976D2;
            transform: translateY(-1px);
        }

        /* === Sidebar Logo Styling === */
        #sidebar-logo {
            display: block; /* Ensure it's a block element */
            max-width: 85%; /* Limit width relative to sidebar */
            height: auto; /* Maintain aspect ratio */
            margin-top: auto; /* Push to the bottom */
            margin-left: auto; /* Center horizontally within sidebar padding */
            margin-right: auto; /* Center horizontally */
            margin-bottom: 10px; /* Space from bottom */
            opacity: 0.9; /* Slightly transparent */
        }

        /* 添加图表容器样式 */
        #chartContainer {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            display: none;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 10;
        }

        /* 修改3D视图容器样式 */
        #model-viewer {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            border: 2px solid rgba(255, 255, 255, 1);
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(5px);
        }

        #model-viewer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid rgba(33, 150, 243, 1);
            border-radius: calc(var(--border-radius) - 2px);
            pointer-events: none;
            margin: 4px;
        }

        #model-viewer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid rgba(255, 255, 255, 1);
            border-radius: calc(var(--border-radius) - 4px);
            pointer-events: none;
            margin: 8px;
        }

        /* 添加文件上传进度条样式 */
        .upload-progress {
            margin-top: 10px;
            height: 4px;
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* 修改表格样式 */
        .excel-container {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 20px;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 1);
            overflow: hidden; /* 修改为hidden，使用内部容器处理滚动 */
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
            margin-bottom: 15px;
        }

        .excel-table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .excel-table th {
            background: rgba(33, 150, 243, 0.3);
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .excel-table td {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            white-space: nowrap;
        }

        .excel-table tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.05);
        }

        .excel-table tbody tr:hover {
            background: rgba(33, 150, 243, 0.1);
        }

        /* 数值列的对齐方式 */
        .excel-table td.numeric {
            text-align: right;
        }

        /* 文本列的对齐方式 */
        .excel-table td.text {
            text-align: left;
        }

        .table-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .table-controls input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            min-width: 200px;
        }

        .table-controls select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(50, 50, 50, 0.8);
            color: white;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
            background-repeat: no-repeat;
            background-position-x: calc(100% - 10px);
            background-position-y: center;
            padding-right: 30px;
        }

        .table-controls select option {
            background: #333;
            color: white;
        }

        .table-pagination {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .page-buttons {
            display: flex;
            gap: 10px;
        }

        .page-buttons button {
            padding: 5px 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>基于AI的安全头盔大数据分析与评估系统</h1>
        </div>

        <div class="file-input-group">
            <input type="file" id="stlFileInput" accept=".stl" style="display: none;">

            <button onclick="document.getElementById('stlFileInput').click()">请选择stl模型</button>
            <input type="text" id="stlFilePath" readonly onclick="document.getElementById('stlFileInput').click()" placeholder="stl模型文件.stl路径">

            <!-- 上传进度条 -->
            <div class="upload-progress">
                <div class="progress-bar"></div>
            </div>
        </div>

        <!-- 3D模型显示区域 -->
        <div id="model-viewer" style="display: none; position: relative;">
            <!-- 加载遮罩 -->
            <div id="loadingOverlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000;">
                <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; margin-bottom: 20px; animation: spin 1s linear infinite;"></div>
                <h2 id="loadingText">预测中，请稍等...</h2>
                <p style="margin-top: 10px; font-size: 14px;">加速度预测可能需要较长时间，请耐心等待</p>
            </div>
        </div>

        <!-- 输入xlsx文件 -->
        <div class="file-input-group">
            <button onclick="selectInputFile()">请选择输入文件</button>
            <input type="text" id="excelFilePath" readonly placeholder="输入文件.xlsx路径（我们提供的）" onclick="selectInputFile()">
        </div>

        <!-- 添加Excel数据显示区域 -->
        <div class="excel-container" id="excelContainer" style="display: none;">
            <div class="table-controls">
                <input type="text" id="tableSearch" placeholder="搜索...">
                <select id="columnSearchSelect" style="min-width: 150px;">
                    <option value="-1">所有列</option>
                    <!-- Column options will be added dynamically -->
                </select>
                <select id="pageSize">
                    <option value="10">10行/页</option>
                    <option value="20">20行/页</option>
                    <option value="50">50行/页</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table class="excel-table">
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="table-pagination">
                <span id="pageInfo">第 0/0 页</span>
                <div class="page-buttons">
                    <button id="prevPage">上一页</button>
                    <button id="nextPage">下一页</button>
                </div>
                <span id="totalInfo">共 0 条记录</span>
            </div>
        </div>

        <div class="button-group">
            <button class="primary-button" onclick="startPrediction()">开始预测</button>
            <div class="radio-group">
                <input type="radio" id="cnas" name="type" checked>
                <label for="cnas">危险点</label>
                <input type="radio" id="other" name="type">
                <label for="other">加速度</label>
            </div>
            <button onclick="exportTable()">导出表格</button>
            <button onclick="showHelp()">帮助文件</button>
            <button onclick="openSelfCheck()">打开自查</button>
            <button onclick="openReport()">打开报告</button>
            <button onclick="endOperation()">结束运行</button>
            <button onclick="exitSystem()">退出系统</button>
            <!-- Add Logo Image Here -->
            <img id="sidebar-logo" src="/templates/images/logo.png" alt="Kuji Sports Logo">
        </div>

        <div class="tab-group" style="display: none;">
            <button class="tab-button active" onclick="switchTab('danger')">危险点预测</button>
            <button class="tab-button" onclick="switchTab('acceleration')">加速度值预测</button>
            
            <div class="tab-content">
                <div id="dangerTab">
                    <button class="action-button" onclick="clearReset()">清除重置</button>
                    <button class="action-button" onclick="exportDangerPoints()">导出危险点坐标</button>
                    <div id="dangerContent">
                    </div>
                </div>
                <div id="accelerationTab">
                </div>
            </div>
        </div>

        <!-- 将图表容器移回主容器 -->
        <div id="chartContainer">
            <canvas id="accelerationChart"></canvas>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls;

        // 初始化3D场景
        function initScene() {
            scene = new THREE.Scene();
            
            // 设置场景背景为透明
            scene.background = null;
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            // 设置渲染器为透明背景
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true  // 启用透明背景
            });
            renderer.setClearColor(0x000000, 0); // 设置透明背景
            
            const container = document.getElementById('model-viewer');
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // 添加轨道控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.5;

            // 添加环境光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // 添加平行光
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);

            camera.position.z = 5;

            // 开始动画循环
            animate();
        }

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // 处理窗口大小变化
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            const container = document.getElementById('model-viewer');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // 初始化场景
        initScene();

        // 处理文件选择
        document.getElementById('stlFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 更新文件路径显示
            document.getElementById('stlFilePath').value = file.name;

            // 创建FormData对象
            const formData = new FormData();
            formData.append('stl_file', file);

            // 显示进度条
            const progressBar = document.querySelector('.progress-bar');
            const progressContainer = document.querySelector('.upload-progress');
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            // 创建XMLHttpRequest对象来获取上传进度
            const xhr = new XMLHttpRequest();
            
            // 监听上传进度
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    console.log('上传进度: ' + percentComplete + '%');
                }
            });

            // 监听上传完成
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // 加载STL文件
                    const loader = new THREE.STLLoader();
                    loader.load(`/uploads/${data.filename}`, function (geometry) {
                        // 清除现有的模型和危险点
                        while(scene.children.length > 0){ 
                            scene.remove(scene.children[0]); 
                        }

                        // 添加新的模型
                        const material = new THREE.MeshPhongMaterial({
                            color: 0x00ff00,
                            specular: 0x111111,
                            shininess: 200
                        });
                        const mesh = new THREE.Mesh(geometry, material);
                        
                        // 直接显示模型
                        scene.add(mesh);

                        // 计算模型的边界框
                        geometry.computeBoundingBox();
                        const box = geometry.boundingBox;
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);

                        // 设置相机位置
                        camera.position.set(maxDim, maxDim, maxDim * 2);
                        camera.lookAt(new THREE.Vector3(0, 0, 0));

                        // 添加光源
                        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                        directionalLight.position.set(1, 1, 1);
                        scene.add(ambientLight);
                        scene.add(directionalLight);

                        // 显示模型查看器，但不显示加载遮罩
                        document.getElementById('model-viewer').style.display = 'block';
                        document.querySelector('#model-viewer #loadingOverlay').style.display = 'none';

                        // 手动触发调整大小以确保正确的尺寸
                        onWindowResize(); 
                    });

                    // 上传完成后隐藏进度条
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 500);
                } else {
                    alert('上传文件时发生错误');
                    progressContainer.style.display = 'none';
                }
            });

            // 发送请求
            xhr.open('POST', '/upload_stl', true);
            xhr.send(formData);
        });

        // 添加Excel处理相关的JavaScript代码
        let excelData = null;
        let currentPage = 1;
        let pageSize = 10;
        let filteredData = [];

        // 处理Excel文件上传
        function selectInputFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Display the selected file name
                document.getElementById('excelFilePath').value = file.name; 

                const formData = new FormData();
                formData.append('excel_file', file);

                try {
                    const response = await fetch('/upload_excel', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    excelData = data;
                    excelData = data; // Store raw data

                    // Populate column search dropdown
                    const columnSelect = document.getElementById('columnSearchSelect');
                    // Clear previous options except the default
                    columnSelect.options.length = 1; 
                    excelData.columns.forEach((col, index) => {
                        const option = document.createElement('option');
                        option.value = index; // Use index as value
                        option.textContent = col;
                        columnSelect.appendChild(option);
                    });

                    // Initial display setup
                    filteredData = [...data.data];
                    displayExcelData();
                    document.getElementById('excelContainer').style.display = 'block';
                } catch (error) {
                    alert('文件处理出错：' + error.message);
                }
            };
            input.click();
        }

        // 显示Excel数据
        function displayExcelData() {
            if (!excelData) return;

            // 设置表头（直接使用后端返回的columns）
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = excelData.columns.map(col => `<th>${col}</th>`).join('');

            // 显示数据
            filteredData = [...excelData.data]; // 更新过滤数据
            updateTableDisplay();
        }

        // 更新表格显示
        function updateTableDisplay() {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredData.slice(startIndex, endIndex);

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = pageData.map((row, rowIndex) => {
                return `<tr>${row.map((cell, cellIndex) => {
                    return `<td>${cell || ''}</td>`;
                }).join('')}</tr>`;
            }).join('');

            // 更新分页信息
            const totalPages = Math.ceil(filteredData.length / pageSize);
            document.getElementById('pageInfo').textContent = `第 ${currentPage}/${totalPages} 页`;
            document.getElementById('totalInfo').textContent = `共 ${filteredData.length} 条记录`;

            // 更新按钮状态
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        // Combined search and filter function
        function filterTableData() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const selectedColumnIndex = parseInt(document.getElementById('columnSearchSelect').value);

            if (!excelData || !excelData.data) {
                filteredData = [];
            } else {
                filteredData = excelData.data.filter(row => {
                    if (selectedColumnIndex === -1) {
                        // Search all columns
                        return row.some(cell => 
                            (cell !== undefined && cell !== null && cell.toString().toLowerCase().includes(searchTerm))
                        );
                    } else {
                        // Search specific column
                        const cellValue = row[selectedColumnIndex];
                        return cellValue !== undefined && cellValue !== null && 
                               cellValue.toString().toLowerCase().includes(searchTerm);
                    }
                });
            }
            
            currentPage = 1; // Reset to first page after filtering
            updateTableDisplay();
        }

        // Add event listeners for filtering
        document.getElementById('tableSearch').addEventListener('input', filterTableData);
        document.getElementById('columnSearchSelect').addEventListener('change', filterTableData);

        // 切换页面大小
        document.getElementById('pageSize').addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            updateTableDisplay();
        });

        // 翻页功能
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateTableDisplay();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                updateTableDisplay();
            }
        });

        function startPrediction() {
            // 检查是否已上传STL文件
            const stlFilePath = document.getElementById('stlFilePath').value;
            if (!stlFilePath) {
                alert('请先上传STL文件');
                return;
            }

            // 检查是否已上传Excel文件
            const excelFilePath = document.getElementById('excelFilePath').value;
            if (!excelFilePath) {
                alert('请先上传Excel文件');
                return;
            }

            // 显示加载遮罩
            const loadingOverlay = document.querySelector('#model-viewer #loadingOverlay');
            const loadingText = document.querySelector('#loadingText');
            loadingOverlay.style.display = 'flex';

            // 获取选中的预测类型
            const predictionType = document.getElementById('cnas').checked ? '危险点' : '加速度';

            // 如果是加速度预测，更新加载文本
            if (predictionType === '加速度') {
                loadingText.textContent = '加速度预测中，这可能需要几分钟时间...';
            }

            // 设置较长的超时时间（5分钟）
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000);

            // 发送预测请求到后端
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    predictionType: predictionType,
                    stlFile: stlFilePath,
                    excelFile: excelFilePath
                }),
                signal: controller.signal
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearTimeout(timeoutId);
                // 隐藏加载遮罩
                loadingOverlay.style.display = 'none';

                if (data.status === 'success') {
                    if (predictionType === '危险点') {
                        // 处理危险点预测结果
                        const points = data.points;
                        console.log("接收到的危险点数据:", points);

                        // 在3D视图中显示危险点
                        displayDangerPoints(points);
                        // 切换到危险点标签页
                        switchTab('danger');
                        alert(data.message);
                    } else {
                        // 处理加速度预测结果
                        const accelerationData = data.accelerate;
                        console.log("接收到的加速度数据:", accelerationData);

                        // 切换到加速度标签页
                        switchTab('acceleration');
                        // 绘制加速度图表
                        drawAccelerationChart(accelerationData);
                        // 显示图表容器
                        document.getElementById('chartContainer').style.display = 'block';
                        alert(data.message);
                    }
                } else {
                    alert('预测失败：' + data.message);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                // 隐藏加载遮罩
                loadingOverlay.style.display = 'none';

                if (error.name === 'AbortError') {
                    alert('预测超时，请重试');
                } else {
                    console.error('Error:', error);
                    alert('预测过程中发生错误: ' + error.message);
                }
            });
        }

        // 添加显示危险点的函数
        function displayDangerPoints(points) {
            // 清除现有的点
            const existingPoints = scene.children.filter(child => 
                child instanceof THREE.Points || 
                (child instanceof THREE.Mesh && child.geometry instanceof THREE.SphereGeometry)
            );
            existingPoints.forEach(point => scene.remove(point));
            
            // 创建点的几何体
            const geometry = new THREE.BufferGeometry();
            
            // 将点数据转换为Float32Array
            const positions = new Float32Array(points.length * 3);
            for (let i = 0; i < points.length; i++) {
                positions[i * 3] = points[i][0];     // x
                positions[i * 3 + 1] = points[i][1]; // y
                positions[i * 3 + 2] = points[i][2]; // z
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            // 创建点的材质
            const material = new THREE.PointsMaterial({
                color: 0xff0000,  // 红色
                size: 8.0,        // 增大点的大小
                sizeAttenuation: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending  // 添加混合效果使点更亮
            });
            
            // 创建点云对象
            const pointCloud = new THREE.Points(geometry, material);
            
            // 为每个点添加一个小球体，使其更容易看见
            points.forEach(point => {
                const sphereGeometry = new THREE.SphereGeometry(2.0, 16, 16); // 增大球体半径
                const sphereMaterial = new THREE.MeshPhongMaterial({
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0.7,
                    emissive: 0xff0000,
                    emissiveIntensity: 0.7
                });
                const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                sphere.position.set(point[0], point[1], point[2]);
                scene.add(sphere);
            });
            
            scene.add(pointCloud);
            
            // 更新渲染
            renderer.render(scene, camera);
        }

        function exportTable() {
            alert('导出表格功能将在后续实现');
        }

        function showHelp() {
            alert('帮助文件功能将在后续实现');
        }

        function openSelfCheck() {
            alert('打开自查功能将在后续实现');
        }

        function openReport() {
            alert('打开报告功能将在后续实现');
        }

        function endOperation() {
            alert('结束运行功能将在后续实现');
        }

        function exitSystem() {
            alert('退出系统功能将在后续实现');
        }

        function clearReset() {
            alert('清除重置功能将在后续实现');
        }

        function exportDangerPoints() {
            alert('导出危险点坐标功能将在后续实现');
        }

        // 添加标签页切换效果
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(t => t.classList.remove('active'));
            
            // 找到对应的标签按钮并激活
            const activeTab = Array.from(tabs).find(t => t.textContent.includes(tab === 'danger' ? '危险点' : '加速度'));
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // 显示对应的内容
            document.getElementById('dangerTab').style.display = tab === 'danger' ? 'block' : 'none';
            document.getElementById('accelerationTab').style.display = tab === 'acceleration' ? 'block' : 'none';
            
            // 如果是加速度标签，确保图表容器可见
            if (tab === 'acceleration') {
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    chartContainer.style.display = 'block';
                }
            }
        }

        // 修改绘制图表的函数
        function drawAccelerationChart(accelerationData) {
            // 检查数据是否存在
            if (!accelerationData || !Array.isArray(accelerationData)) {
                console.error('无效的加速度数据');
                return;
            }

            // 确保我们使用数组中的第一个元素，因为后端返回的是嵌套数组
            const data = Array.isArray(accelerationData[0]) ? accelerationData[0] : accelerationData;

            // 检查数据是否为空
            if (!data || data.length === 0) {
                console.error('加速度数据为空');
                return;
            }

            const ctx = document.getElementById('accelerationChart').getContext('2d');
            const labels = Array.from({length: data.length}, (_, i) => i + 1);

            // 创建完整的数据序列
            const allPoints = data.map((value, index) => {
                const numValue = Number(value);
                if (isNaN(numValue)) {
                    console.error(`无效的加速度值: ${value}`);
                    return null;
                }
                return numValue;
            });

            // 根据阈值将数据点分类
            const normalPoints = allPoints.map(value => value <= 230 ? value : null);
            const dangerPoints = allPoints.map(value => value > 230 && value <= 250 ? value : null);
            const failurePoints = allPoints.map(value => value > 250 ? value : null);

            // 如果已经存在图表，先销毁它
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '正常点 (≤230)',
                            data: normalPoints,
                            borderColor: 'rgb(75, 192, 75)',
                            backgroundColor: 'rgb(75, 192, 75)',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: false,
                            tension: 0.1,
                            spanGaps: true,
                            order: 3  // 最上层显示
                        },
                        {
                            label: '危险点 (230-250)',
                            data: dangerPoints,
                            borderColor: 'rgb(220, 53, 69)',
                            backgroundColor: 'rgb(220, 53, 69)',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: false,
                            tension: 0.1,
                            spanGaps: true,
                            order: 2
                        },
                        {
                            label: '失败点 (>250)',
                            data: failurePoints,
                            borderColor: 'rgb(173, 181, 189)',
                            backgroundColor: 'rgb(173, 181, 189)',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: false,
                            tension: 0.1,
                            spanGaps: true,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '加速度预测结果',
                            color: 'white',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'white'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `加速度: ${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '加速度索引',
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '加速度值',
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white'
                            }
                        }
                    }
                }
            });

            // 显示图表容器
            document.getElementById('chartContainer').style.display = 'block';
        }
    </script>
</body>
</html> 